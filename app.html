<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Description App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            padding: 32px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 600px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .message-box {
            min-height: 120px;
            background-color: #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem; /* text-lg */
            color: #334155; /* slate-700 */
            text-align: center;
            line-height: 1.6;
            word-wrap: break-word;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6; /* blue-500 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .file-upload {
            display: none;
        }
        .file-upload-label {
            cursor: pointer;
            padding: 12px 24px;
            background-color: #4CAF50;
            color: white;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.3s;
        }
        .file-upload-label:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-gray-800">Video Description Generator</h1>
        <p class="text-gray-600">Upload a video or provide a YouTube link to generate a description.</p>

        <div class="message-box" id="messageBox">
            <span id="messageText">Choose a video file or enter a YouTube link below.</span>
        </div>

        <div class="flex flex-col gap-4">
            <!-- File Upload Section -->
            <div class="flex flex-col items-center gap-2">
                <input type="file" id="videoUpload" class="file-upload" accept="video/*">
                <label for="videoUpload" class="file-upload-label">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Upload Video
                </label>
                <span id="selectedFileName" class="text-sm text-gray-600"></span>
            </div>

            <!-- YouTube Link Section -->
            <div class="flex flex-col sm:flex-row items-center gap-3">
                <input type="text" id="youtubeInput" placeholder="Or enter YouTube link" class="flex-grow w-full sm:w-auto p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-700">
                <button id="submitYoutubeButton" class="bg-gray-700 hover:bg-gray-800 text-white font-semibold py-3 px-6 rounded-xl shadow-md transition duration-300 ease-in-out w-full sm:w-auto">
                    Process YouTube
                </button>
            </div>
        </div>

        <div id="loadingSpinner" class="hidden loading-spinner"></div>
    </div>

    <script type="module">
        // Firebase imports for authentication
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // DOM Elements
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const videoUpload = document.getElementById('videoUpload');
        const selectedFileName = document.getElementById('selectedFileName');
        const youtubeInput = document.getElementById('youtubeInput');
        const submitYoutubeButton = document.getElementById('submitYoutubeButton');
        const loadingSpinner = document.getElementById('loadingSpinner');

        // Firebase variables
        let app;
        let db;
        let auth;
        let userId = 'anonymous'; // Default to anonymous
        let isAuthReady = false;

        // --- Firebase Initialization ---
        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        /**
         * Initializes Firebase and authenticates the user.
         */
        const initializeFirebase = async () => {
            if (firebaseConfig) {
                try {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    // Sign in using custom token if provided, otherwise anonymously
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log('Signed in with custom token.');
                    } else {
                        await signInAnonymously(auth);
                        console.log('Signed in anonymously.');
                    }

                    // Listen for auth state changes to get the user ID
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log('User ID:', userId);
                        } else {
                            userId = crypto.randomUUID(); // Fallback for truly anonymous or unauthenticated states
                            console.log('No user signed in. Using a random UUID:', userId);
                        }
                        isAuthReady = true;
                    });

                } catch (error) {
                    console.error("Error initializing Firebase or authenticating:", error);
                    showMessage("Error: Could not initialize app services. Please try again later.");
                }
            } else {
                console.warn("Firebase config not found. App will run without Firebase services.");
                isAuthReady = true; // Still allow app to function without persistence
            }
        };

        // --- UI Utility Functions ---

        /**
         * Displays a message in the message box.
         * @param {string} msg - The message to display.
         */
        function showMessage(msg) {
            messageText.textContent = msg;
        }

        /**
         * Shows or hides the loading spinner.
         * @param {boolean} show - True to show, false to hide.
         */
        function showLoading(show) {
            if (show) {
                loadingSpinner.classList.remove('hidden');
                videoUpload.disabled = true;
                submitYoutubeButton.disabled = true;
                youtubeInput.disabled = true;
                submitYoutubeButton.textContent = 'Processing...';
            } else {
                loadingSpinner.classList.add('hidden');
                videoUpload.disabled = false;
                submitYoutubeButton.disabled = false;
                youtubeInput.disabled = false;
                submitYoutubeButton.textContent = 'Process YouTube';
            }
        }

        /**
         * Checks if a string is a valid YouTube URL and extracts video ID.
         * @param {string} url - The string to check.
         * @returns {string|null} - The YouTube video ID or null if not a valid YouTube URL.
         */
        function getYouTubeVideoId(url) {
            const regex = /(?:https?:\/\/)?(?:www\.)?(?:m\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=|embed\/|v\/|)([\w-]{11})(?:\S+)?/g;
            const match = regex.exec(url);
            return match ? match[1] : null;
        }

        // --- Event Listeners ---

        submitYoutubeButton.addEventListener('click', async () => {
            const youtubeUrl = youtubeInput.value.trim();
            if (!youtubeUrl) {
                messageText.textContent = "Please enter a YouTube URL";
                return;
            }

            showLoading(true);
            messageText.textContent = "Processing YouTube video...";

            try {
                const response = await fetch('http://127.0.0.1:8000/api/process-youtube/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        youtube_url: youtubeUrl,
                        user_id: userId
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    messageText.textContent = data.description;
                } else {
                    throw new Error(data.error || 'Failed to process YouTube video');
                }
            } catch (error) {
                messageText.textContent = `Error: ${error.message}`;
                console.error('Error:', error);
            } finally {
                showLoading(false);
            }
        });

        // File Upload Handler
        videoUpload.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (file) {
                selectedFileName.textContent = file.name;
                showLoading(true);
                messageText.textContent = "Processing video...";

                const formData = new FormData();
                formData.append('video', file);
                formData.append('user_id', userId);

                try {
                    const response = await fetch('http://127.0.0.1:8000/api/process-video/', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    if (response.ok) {
                        messageText.textContent = data.description;
                    } else {
                        throw new Error(data.error || 'Failed to process video');
                    }
                } catch (error) {
                    messageText.textContent = `Error: ${error.message}`;
                    console.error('Error:', error);
                } finally {
                    showLoading(false);
                }
            }
        });

        // --- Initial Setup ---
        window.onload = () => {
            initializeFirebase();
            showMessage("Upload a video or enter a YouTube link to begin.");
        };
    </script>
</body>
</html>
